
@{
    ViewBag.Title = "GetKPI";
    Layout = "~/Views/Shared/_LayoutNew.cshtml";
}
<style>
    .search-contaienr {
        margin-bottom: 5px;
    }
    .n-row{
        margin-bottom: 5px;
    }
</style>
<link href="~/Content/bootstrap-datepicker/bootstrap-datepicker.min.css" rel="stylesheet" type="text/css" />
<script src="~/Scripts/bootstrap-datepicker/bootstrap-datepicker.min.js" type="text/javascript"></script>
<div>
    <div class="search-contaienr">
        <div class="row n-row">
            <label class="col-xs-2">UserName</label>
            <div class="col-xs-3">
                <input type="text" class="form-control"
                       id="search-key" name="search-key" value="@ViewBag.uName" />
            </div>
        </div>
        <div class="row n-row">
            <label class="col-xs-2">Date Period</label>
            <div class="col-xs-3">
                <div class="input-group date" data-date-format="yyyy-mm-dd">
                    <input type="text" class="form-control" id="s-date" name="s-date" value="@ViewBag.sDate" readonly>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-th"></span>
                    </span>
                </div>
            </div>
            <div class="col-xs-1 text-center">~</div>
            <div class="col-xs-3">
                <div class="input-group date" data-date-format="yyyy-mm-dd">
                    <input type="text" class="form-control" id="e-date" name="e-date" value="@ViewBag.eDate" readonly>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-th"></span>
                    </span>
                </div>
            </div>
            <div class="col-xs-1">
                <input type="button" class="btn btn-success" value="Search" id="btn-search" name="btn-search" />
            </div>
        </div>
    </div>
    @if (ViewBag.data1 != null)
    {
        if (ViewBag.flg == 1)
        {
            <table class="table table-hover table-striped">
                <thead>
                    <tr>
                        <th>UserName</th>
                        <th>Item</th>
                        <th>Half-Year Count</th>
                        <th>Half-Year Rank</th>
                        <th>Year Count</th>
                        <th>Year Rank</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var idx = 0;
                        foreach (var item in ViewBag.data2)
                        {
                            if (idx < ViewBag.data2.Count - 2)
                            {
                                <tr>
                                    <td rowspan="5">@item.Key.Split(new char[] { '@' })[0]</td>
                                    <td>Task</td>
                                    <td>@item.Value.Task</td>
                                    <td>@(Math.Round(item.Value.Task / ViewBag.data2["h_avg"].Task, 4) * 100) %</td>
                                    <td>@(ViewBag.data1[item.Key].Task)</td>
                                    <td>@(Math.Round(ViewBag.data1[item.Key].Task / ViewBag.data2["y_avg"].Task, 4) * 100) %</td>
                                </tr>
                                <tr>
                                    <td>CriticalTask</td>
                                    <td>@item.Value.CriticalTask</td>
                                    <td>@(Math.Round(item.Value.CriticalTask / ViewBag.data2["h_avg"].CriticalTask, 4) * 100) %</td>
                                    <td>@(ViewBag.data1[item.Key].CriticalTask)</td>
                                    <td>@(Math.Round(ViewBag.data1[item.Key].CriticalTask / ViewBag.data2["y_avg"].CriticalTask, 4) * 100) %</td>
                                </tr>
                                <tr>
                                    <td>Bug</td>
                                    <td>@item.Value.Bug</td>
                                    <td>@(Math.Round(item.Value.Bug / ViewBag.data2["h_avg"].Bug, 4) * 100) %</td>
                                    <td>@(ViewBag.data1[item.Key].Bug)</td>
                                    <td>@(Math.Round(ViewBag.data1[item.Key].Bug / ViewBag.data2["y_avg"].Bug, 4) * 100) %</td>
                                </tr>
                                <tr>
                                    <td>RMA</td>
                                    <td>@item.Value.RMA</td>
                                    <td>@(Math.Round(item.Value.RMA / ViewBag.data2["h_avg"].RMA, 4) * 100) %</td>
                                    <td>@(ViewBag.data1[item.Key].RMA)</td>
                                    <td>@(Math.Round(ViewBag.data1[item.Key].RMA / ViewBag.data2["y_avg"].RMA, 4) * 100) %</td>
                                </tr>
                                <tr>
                                    <td>DebugTree</td>
                                    <td>@item.Value.DebugTree</td>
                                    <td>@(Math.Round(item.Value.DebugTree / ViewBag.data2["h_avg"].DebugTree, 4) * 100) %</td>
                                    <td>@(ViewBag.data1[item.Key].DebugTree)</td>
                                    <td>@(Math.Round(ViewBag.data1[item.Key].DebugTree / ViewBag.data2["y_avg"].DebugTree, 4) * 100) %</td>
                                </tr>
                                idx++;
                            }
                        }
                    }
                </tbody>
            </table>
        }
        else
        {
            <table class="table table-hover table-striped">
                <thead>
                    <tr>
                        <th>UserName</th>
                        <th>Item</th>
                        <th>Count</th>
                        <th>Rank</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var idx = 0;
                        foreach (var item in ViewBag.data1)
                        {
                            if (idx < ViewBag.data1.Count - 2)
                            {
                                <tr>
                                    <td rowspan="5">@item.Key.Split(new char[] { '@' })[0]</td>
                                    <td>Task</td>
                                    <td>@item.Value.Task</td>
                                    <td>@(Math.Round(item.Value.Task / ViewBag.data1["h_avg"].Task, 4) * 100) %</td>
                                </tr>
                                <tr>
                                    <td>CriticalTask</td>
                                    <td>@item.Value.CriticalTask</td>
                                    <td>@(Math.Round(item.Value.CriticalTask / ViewBag.data1["h_avg"].CriticalTask, 4) * 100) %</td>
                                </tr>
                                <tr>
                                    <td>Bug</td>
                                    <td>@item.Value.Bug</td>
                                    <td>@(Math.Round(item.Value.Bug / ViewBag.data1["h_avg"].Bug, 4) * 100) %</td>
                                </tr>
                                <tr>
                                    <td>RMA</td>
                                    <td>@item.Value.RMA</td>
                                    <td>@(Math.Round(item.Value.RMA / ViewBag.data1["h_avg"].RMA, 4) * 100) %</td>
                                </tr>
                                <tr>
                                    <td>DebugTree</td>
                                    <td>@item.Value.DebugTree</td>
                                    <td>@(Math.Round(item.Value.DebugTree / ViewBag.data1["h_avg"].DebugTree, 4) * 100) %</td>
                                </tr>
                                idx++;
                            }
                        }
                    }
                </tbody>
            </table>
        }
    }
</div>
<script>
    $(function () {
        $('.date').datepicker({
            autoclose: true
        });
        var allusers;
        $.post('/User/GetUsers',
            {}, function (output) {
                allusers = output.data;
            });
        $('#search-key').autoComplete({
            minChars: 0,
            source: function (term, suggest) {
                term = term.toLowerCase();
                var choices = allusers;
                var suggestions = [];
                for (i = 0; i < choices.length; i++) {
                    if (~(choices[i]).toLowerCase().indexOf(term))
                        suggestions.push(choices[i]);
                }
                suggest(suggestions);

            }
        });
        $('body').on('click', '#btn-search', function () {
            var uName = $.trim($('#search-key').val());
            var sDate = $.trim($('#s-date').val());
            var eDate = $.trim($('#e-date').val());
            window.location.href = '/User/GetKPI?uName=' + uName + '&sDate=' + sDate + '&eDate' + eDate;
        });
    })
</script>
