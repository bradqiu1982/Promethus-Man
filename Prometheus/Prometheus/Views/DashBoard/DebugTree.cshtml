
@{
    ViewBag.Title = "DebugTree";
    if (ViewBag.isMe)
    {
        Layout = "~/Views/Shared/_LayoutLogin.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_LayoutNew.cshtml";
    }
}

@if (ViewBag.isie8)
{
    <p><h1>Sorry, this function is not supported by IE8</h1></p>
    <br />
    <p><h1>Please use IE10+ or firefox</h1></p>
}
else
{

    <link href="~/Content/common.css" rel="stylesheet" type="text/css" />
    <link href="~/Content/jsmind.css" rel="stylesheet" type="text/css" />
    <script src="~/Scripts/jsmind/jsmind.js" type="text/javascript"></script>

    <div class="row">
        <div class="nav navbar-nav navbar-left">
            <ol class="breadcrumb">
                <li><a href="#">Dashboard</a></li>
                <li class="active">Debug Tree</li>
            </ol>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-4">
            @if (ViewBag.List.Count > 0)
            {
                <table id="ondatatable" class="table table-striped" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Orignal Code</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in ViewBag.List)
                    {
                            <tr>
                                <td data-id="@item" class="cursor-pointer">@item</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
        <div class="col-xs-8">
            <div class="errcode_jm_container" id="jsmind_container"></div>
        </div>
    </div>
    <div class="modal fade" id="analysis-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title" id="myLargeModalLabel">Analysis Detail</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="analysis-id" />
                    <div class="row form-group">
                        <label class="col-xs-2">Analysis Title</label>
                        @if (ViewBag.isMe)
                        {
                            <div class="col-xs-8" id="display-title">
                                <input type="text" class="form-control" style="width: 80%; display: inline-block;" id="span-title" name="span-title" readonly />
                            </div>
                        }
                        else
                        {
                            <div class="col-xs-8 hidden" id="display-title">
                                <input type="text" class="form-control" style="width: 80%; display: inline-block;" id="span-title" name="span-title" readonly />
                                <input type="button" class="btn btn-success"
                                       id="btn-edit" name="btn-edit" value="Edit" />
                            </div>
                            <div class="col-xs-8" id="edit-title">
                                <input type="text" class="form-control" style="width: 80%; display: inline-block;"
                                       id="analysis-name" name="analysis-name" />
                                <input type="button" class="btn btn-success"
                                       id="btn-save" name="btn-save" value="Save" />
                            </div>
                        }
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">FailureDetail</h3>
                        </div>
                        <div class="panel-body">
                            <div class="row" id="des-info">FailureDetail</div>
                            <div class="row">
                                <div class="col-xs-4 col-xs-offset-5">
                                    Reporter: <span id="des-reporter"></span>
                                </div>
                                <div class="col-xs-3">
                                    <span id="des-datetime">@DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">RootCause</h3>
                        </div>
                        <div class="panel-body">
                            <div class="row" id="rc-info">RootCause</div>
                            <div class="row">
                                <div class="col-xs-4 col-xs-offset-5">
                                    Reporter: <span id="rc-reporter"></span>
                                </div>
                                <div class="col-xs-3">
                                    <span id="rc-datetime">@DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Result</h3>
                        </div>
                        <div class="panel-body">
                            <div class="row" id="res-info">Result</div>
                            <div class="row">
                                <div class="col-xs-4 col-xs-offset-5">
                                    Reporter: <span id="res-reporter"></span>
                                </div>
                                <div class="col-xs-3">
                                    <span id="res-datetime">@DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var _jm = null;
        $(function () {
            $('#ondatatable').DataTable({
                'sPaginationType': 'simple',
                'bLengthChange': false,
                'iDisplayLength': 15,
                "bAutoWidth": false,
                "ordering": false,
                "aaSorting": [],
            });
        })

        $('body').on('click', '#ondatatable tr td', function () {
            var options = {
                container: 'jsmind_container',
                theme: 'greensea',
                editable: true,
                mode: 'side',
                view: {
                    hmargin: 10,
                    vmargin: 10,
                    line_width: 2,
                    line_color: '#555'
                },
                layout: {
                    hspace: 20,
                    vspace: 10,
                    pspace: 0
                }
            }
            $('#jsmind_container').empty();
            var OriginalCode = $(this).attr('data-id');
            $.post('/Project/ProjectErrorData',
            {
                OriginalCode: OriginalCode
            }, function (output) {
                if (output.success) {
                    var mind = {
                        "format": "node_array",
                        "data": output.jm_data
                    };
                    _jm = jsMind.show(options, mind);
                }
            });
        })

        $('body').on('click', 'jmnode', function () {
            var select_node = _jm.get_selected_node();
            if (select_node.isroot || select_node.children.length > 0) {
                return false;
            }
            var analysis_id = select_node.id;
            var isMe = '@ViewBag.IsMe';
            if (isMe != 'True') {
                $('#display-title').addClass('hidden');
                $('#edit-title').removeClass('hidden');
            }
            $.post('/Project/RetrieveErrorCommentsByAnalyzeID',
            {
                id: analysis_id
            }, function (output) {
                $('#analysis-id').val(analysis_id);
                $('#span-title').val(output.title.content);
                $('#analysis-name').val(output.title.content);
                $('#des-info').html(output.failuredetail.content);
                $('#des-reporter').html(output.failuredetail.reporter);
                $('#des-datetime').html(output.failuredetail.time);
                $('#rc-info').html(output.rootcause.content);
                $('#rc-reporter').html(output.rootcause.reporter);
                $('#rc-datetime').html(output.rootcause.time);
                $('#res-info').html(output.result.content);
                $('#res-reporter').html(output.result.reporter);
                $('#res-datetime').html(output.result.time);
                $('#analysis-modal').modal('show');
            })
            })

        $('body').on('click', '#btn-edit', function () {
            $('#display-title').addClass('hidden');
            $('#edit-title').removeClass('hidden');
        })

        $('body').on('click', '#btn-save', function () {
            var id = $('#analysis-id').val();
            var name = $('#analysis-name').val();
            $.post('/Project/UpdateErrorCommentTitle', {
                id: id,
                name: name
            }, function (output) {
                if (output.success) {
                    $('#span-title').val(name);
                    $('jmnode[nodeid=' + id + ']').html(name);
                    $('#display-title').removeClass('hidden');
                    $('#edit-title').addClass('hidden');
                }
            })
        })
    </script>
}
