
@{
    ViewBag.Title = "ProjectDash";
    Layout = "~/Views/Shared/_LayoutNew.cshtml";
}

<div class="row">
    <div class="col-xs-8">
        <div class="nav navbar-nav navbar-left">
            <img src="~/Content/images/PJ/Task.png" style="height:40px; width:40px;margin-right: 10px;">
        </div>
        <div class="nav navbar-nav navbar-left">
            <ol class="breadcrumb" style="width:600px">
                <li><a data-toggle="tooltip" title="Goto ViewAll" href="/Project/ViewAll">All Projects</a></li>
                @if (ViewBag.PJKey != null)
                {
                    <li><a data-toggle="tooltip" title="Goto Project Task" href="/Project/ProjectIssues?ProjectKey=@ViewBag.PJKey">Project Task</a></li>
                }
                <li class="active">Project Dash Board</li>
            </ol>
        </div>
    </div>
    <div class="col-xs-4"></div>
</div>

<div class="row">
    <div class="col-xs-12">&nbsp;</div>
</div>


@if (ViewBag.PJKey != null)
{
    @*<script src="~/Scripts/lobilist/lib/jquery/jquery.min.js"></script>*@
    @*<script src="~/Scripts/lobilist/lib/jquery/jquery-ui.min.js"></script>*@
    <script src="~/Scripts/lobilist/lib/jquery/jquery.ui.touch-punch-improved.js"></script>
    @*<script src="~/Scripts/lobilist/lib/bootstrap/js/bootstrap.min.js"></script>*@
    <script src="~/Scripts/lobilist/dist/lobilist.js"></script>
    <script src="~/Scripts/lobilist/lib/lobibox/js/lobibox.min.js"></script>
    <script src="~/Scripts/lobilist/lib/highlight/highlight.pack.js"></script>

    <div class="bs-example">
        <div id="todo-lists-basic-demo"></div>
    </div>
    <input type="text" class="hide" id="ispjmember" name="ispjmember" value="@(ViewBag.IsPJMember)">
    <input type="text" class="hide" id="pjkey" name="pjkey" value="@(ViewBag.PJKey)">
    <input type="text" class="hide" id="currentissuekey" name="currentissuekey" value="">

    <script type="text/javascript">
        function refreshdetailmodal(id)
        {
            $.post('/Issue/PMTaskDetail',{
                id:id
            },function(output){
                if(output.success)
                {
                    $('#currentissuekey').val(id);
                    $('#taskattachments').empty();
                    $('#RelatedTask').empty();
                    $('#taskcomments').empty();
                    $('#taskremark').val('');

                    {
                        var appendstr = "";
                        appendstr += '<tr>';
                        appendstr += '<td><input type="text" class="form-control" id="linksummary" name="linksummary" placeholder="Summary" value=""></td>';
                        appendstr += '<td><input type="text" class="form-control" id="linkassignee" name="linkassignee" placeholder="Asignee" value=""></td>';
                        appendstr += '<td><input type="text" class="form-control" id="linkduedate" name="linkduedate" placeholder="Due Date" value=""></td>';
                        appendstr += '<td><input type="text" class="form-control" id="linkdesc" name="linkdesc" placeholder="Description" value=""></td>';
                        appendstr += '<td></td>';
                        appendstr += '<td><button class="btn btn-success" id="addlinktaskbtn" name="addlinktaskbtn" onclick="CreateLinkTask()">Add</button></td>';
                        appendstr += '<td></td>';
                        appendstr += '</tr>';
                        $('#RelatedTask').append(appendstr);
                    }

                    $('#tasktitle').html(output.taskinfo.tasktitle);
                    $('#taskassignee').html(output.taskinfo.taskassignee);
                    $('#taskduedate').html(output.taskinfo.taskduedate);
                    $('#taskresolution').html(output.taskinfo.taskresolution);

                    $.each(output.attachlist, function (i, val) {
                        var link = '<div><a href="' + val.url + '" target="_blank">' + val.fn + '</a></div>';
                        $('#taskattachments').append(link);
                    });

                    $.each(output.linktasklist, function (i, val) {
                        var appendstr = '<tr>';
                        appendstr += '<td>'+val.tasktitle+'</td>';
                        appendstr += '<td>'+val.taskassignee+'</td>';
                        appendstr += '<td>'+val.taskduedate+'</td>';
                        appendstr += '<td><input type="text" class="form-control" id="'+val.taskid+'_desc" name="'+val.taskid+'_desc" placeholder="Description" value="'+val.taskdesc+'"></td>';
                        appendstr += '<td><input type="text" readonly="readonly" class="form-control" id="'+val.taskid+'_status" name="'+val.taskid+'_status" placeholder="Status" value="'+val.taskresolution+'"></td>';
                        appendstr += '<td><button class="btn btn-success" id="addlinktaskbtn" name="addlinktaskbtn" onclick="SaveLinkDesc(\''+val.taskid+'\')">Save</button></td>';
                        appendstr += '<td><button class="btn btn-success" id="addlinktaskbtn" name="addlinktaskbtn" onclick="DoneLinkTask(\''+val.taskid+'\')">Done</button></td>';
                        appendstr += '</tr>'
                        $('#RelatedTask').append(appendstr);
                    });

                    $.each(output.commentlist, function (i, val) {
                        var appendstr = '';
                        appendstr += '<div class="well" mytp="HOVER" style="margin-bottom:2px;padding-bottom:2px;margin-top:2px;padding-top:2px;background-color:transparent !important;border-left-color:#006DC0;border-top-color:transparent !important;border-right-color:transparent !important;border-bottom-color:transparent !important;border-top-left-radius:0px;border-bottom-left-radius:0px;border-top-width:0px">';
                        appendstr += '<div class="row" mytp="HOVER" style="margin-top:2px;margin-bottom:2px;padding-top:2px;padding-bottom:2px;">';
                        appendstr += '<div class="row" style="margin-top:2px;margin-bottom:2px;padding-top:2px;padding-bottom:2px;">';
                        appendstr += '<div class="col-xs-6">';
                        appendstr += '<div class="col-xs-9">'+val.reporter+'&nbsp;&nbsp;'+val.commentdate+'</div>';
                        appendstr += '</div>';
                        appendstr += '<div class="col-xs-6"></div>';
                        appendstr += '</div>';
                        appendstr += '<div class="row" style="margin-top:2px;margin-bottom:2px;padding-top:2px;padding-bottom:2px;">';
                        appendstr += '<div class="col-xs-1"></div>';
                        appendstr += '<div class="col-xs-11">'+val.content+'</div>';
                        appendstr += '</div>';
                        appendstr += '</div>';
                        appendstr += '</div>';
                        $('#taskcomments').append(appendstr);
                    });

                    $('#taskdetailmodal').modal('show');

                    $('#linkduedate').datepicker({
                        changeMonth: true,
                        changeYear: true,
                        dateFormat: 'yy-mm-dd'
                    });

                    $('#linkassignee').autoComplete({
                        minChars: 0,
                        source: function (term, suggest) {
                            term = term.toLowerCase();
                            var choices = @Html.Raw(ViewBag.pjmemlist);
                            var suggestions = [];
                            for (i = 0; i < choices.length; i++)
                                if (~choices[i].toLowerCase().indexOf(term)) suggestions.push(choices[i]);
                            suggest(suggestions);
                        }
                    });
                }
            });
        }


    $(function () {
        //Basic example
        var ispjmember = $('#ispjmember').val();
        var todoremove = false;
        if (ispjmember == 'TRUE')
        {
            todoremove = true;
        }

        $('#todo-lists-basic-demo').lobiList({
            actions: {
                load: '/Project/InitPJMGTask?PJKey=@ViewBag.PJKey',
                insert: '/Project/TodoListAdd',
                delete: '/Project/TodoListDelete',
                update: '/Project/TodoListUpdate',
                move: '/Project/TodoListMove'
            },
            enableTodoRemove: todoremove,
            enableTodoEdit: false,
            controls:[]
        });

        $('body').on('click', '.lobilist-item-title, .lobilist-item-description', function(){
            var id = $(this).parent().attr('data-id');
            refreshdetailmodal(id);
        });

        $('body').on('click', '#ct_btn', function(){
            var pjkey = $('#pjkey').val();
            var title = $('#summary_ct').val();
            var description = $('#description_ct').val();
            var duedate = $('#duedate_ct').val();
            var assignee = $('#assignee_ct').val();

            if(title == '' || duedate == '' || assignee == '')
            {
                alert('title,duedate,assignee should not be empty!');
                return false;
            }

            $('#createtaskmodal').modal('hide');
            $.post('/Project/TodoListAdd',{
                pjkey:pjkey,
                title:title,
                duedate:duedate,
                assignee:assignee,
                description:description
            },function(output){
                $('#summary_ct').val('');
                $('#description_ct').val('');
                $('#duedate_ct').val('');
                $('#assignee_ct').val('');
                window.location.reload();
            });
        });



    });

    $(document).ready(function () {
        $('#duedate_ct').datepicker({
            changeMonth: true,
            changeYear: true,
            dateFormat: 'yy-mm-dd'
        });

        $('#assignee_ct').autoComplete({
            minChars: 0,
            source: function (term, suggest) {
                term = term.toLowerCase();
                var choices = @Html.Raw(ViewBag.pjmemlist);
                var suggestions = [];
                for (i = 0; i < choices.length; i++)
                    if (~choices[i].toLowerCase().indexOf(term)) suggestions.push(choices[i]);
                suggest(suggestions);
            }
        });

    });

        function UpdateIssueLink()
        {
            var id = $('#currentissuekey').val();
            if(id != '')
            {
                window.open('/Issue/UpdateIssue?IssueKey='+id,'_blank');
            }
        }

        function LinkExistTasks()
        {
            $('#taskdetailmodal').modal('hide');

            $('#searchkey').val('')
            $('#demoparent').empty();
            $('#demoparent').append('<div id="linktask-demo"></div>');

            var id = $('#currentissuekey').val();
            $('#linktask-demo').lobiList({
                actions: {
                    load: '/Issue/InitTaskLink?IssueKey='+id+'&searchkey=',
                    move: '/Issue/MoveTaskLink'
                },
                enableTodoRemove: false,
                enableTodoEdit: false,
                controls: []
            });

            $('#linktaskmodal').modal({ backdrop: 'static' });
        }

        function UploadAttach()
        {
            var id = $('#currentissuekey').val();
            $.ajaxFileUpload(
                {
                    url: '/Issue/UpdateTaskAttachment?id='+id,
                    secureuri: false,
                    fileElementId: 'file3',
                    dataType: 'json',
                    success: function (data, status) {
                        var link = '<div><a href="' + data.url + '" target="_blank">' + data.fn + '</a></div>';
                        $('#taskattachments').append(link);
                    },
                    error: function (e) {
                        alert(e);
                    }
                });
        }

        function CreateLinkTask()
        {
            var pjkey = $('#pjkey').val();
            var title = $('#linksummary').val();
            var description = $('#linkdesc').val();
            var duedate = $('#linkduedate').val();
            var assignee = $('#linkassignee').val();
            var originalid = $('#currentissuekey').val();

            if(title == '' || duedate == '' || assignee == '')
            {
                alert('Link Task title,duedate,assignee should not be empty!');
                return false;
            }

            $('#linksummary').val('');
            $('#linkdesc').val('');
            $('#linkduedate').val('');
            $('#linkassignee').val('');

            $.post('/Project/CreateLinkTask',{
                pjkey:pjkey,
                title:title,
                duedate:duedate,
                assignee:assignee,
                originalid:originalid,
                description:description
            },function(output){
                if(output.success)
                {
                    var appendstr = '<tr>';
                    appendstr += '<td>'+output.task.Summary+'</td>';
                    appendstr += '<td>'+output.task.Assignee+'</td>';
                    appendstr += '<td>'+output.task.DueDateStr+'</td>';
                    appendstr += '<td><input type="text" class="form-control" id="'+output.task.IssueKey+'_desc" name="'+output.task.IssueKey+'_desc" placeholder="Description" value="'+output.task.Description+'"></td>';
                    appendstr += '<td><input type="text" readonly="readonly" class="form-control" id="'+output.task.IssueKey+'_status" name="'+output.task.IssueKey+'_status" placeholder="Status" value="'+output.task.Resolution+'"></td>';
                    appendstr += '<td><button class="btn btn-success" id="addlinktaskbtn" name="addlinktaskbtn" onclick="SaveLinkDesc(\''+output.task.IssueKey+'\')">Save</button></td>';
                    appendstr += '<td><button class="btn btn-success" id="addlinktaskbtn" name="addlinktaskbtn" onclick="DoneLinkTask(\''+output.task.IssueKey+'\')">Done</button></td>';
                    appendstr += '</tr>'
                    $('#RelatedTask').append(appendstr);
                }
            });
        }

        function SaveLinkDesc(id)
        {
            var desc = $('#'+id+'_desc').val();
            if(desc != '')
            {
                $.post('/Project/AddPMLinkTaskRemark',{
                    id:id,
                    taskremark:desc
                },function(){

                })
            }
        }

        function DoneLinkTask(id)
        {
            if(id != '')
            {
                $.post('/Project/ClosePMLinkTask',{
                    id:id
                },function(output){
                    if(output.success)
                    {
                        $('#'+id+'_status').val('Done');
                    }
                })
            }
        }

        function SaveTaskRemark()
        {
            var id = $('#currentissuekey').val();
            var taskremark = $('#taskremark').val();
            if(taskremark != '')
            {
                $.post('/Project/AddPMTaskRemark',{
                    id:id,
                    taskremark:taskremark
                },
                function(output)
                {
                    if(output.success)
                    {
                        var taskremark = $('#taskremark').val('');

                        var appendstr = '';
                        appendstr += '<div class="well" mytp="HOVER" style="margin-bottom:2px;padding-bottom:2px;margin-top:2px;padding-top:2px;background-color:transparent !important;border-left-color:#006DC0;border-top-color:transparent !important;border-right-color:transparent !important;border-bottom-color:transparent !important;border-top-left-radius:0px;border-bottom-left-radius:0px;border-top-width:0px">';
                        appendstr += '<div class="row" mytp="HOVER" style="margin-top:2px;margin-bottom:2px;padding-top:2px;padding-bottom:2px;">';
                        appendstr += '<div class="row" style="margin-top:2px;margin-bottom:2px;padding-top:2px;padding-bottom:2px;">';
                        appendstr += '<div class="col-xs-6">';
                        appendstr += '<div class="col-xs-9">'+output.remark.Reporter+'&nbsp;&nbsp;'+output.remark.CommentDateStr+'</div>';
                        appendstr += '</div>';
                        appendstr += '<div class="col-xs-6"></div>';
                        appendstr += '</div>';
                        appendstr += '<div class="row" style="margin-top:2px;margin-bottom:2px;padding-top:2px;padding-bottom:2px;">';
                        appendstr += '<div class="col-xs-1"></div>';
                        appendstr += '<div class="col-xs-11">'+output.remark.Comment+'</div>';
                        appendstr += '</div>';
                        appendstr += '</div>';
                        appendstr += '</div>';
                        $('#taskcomments').append(appendstr);
                    }
                });
            }
        }

    </script>

    <div class="modal" id="createtaskmodal" tabindex="-1" role="dialog" aria-labelledby="createtaskmodalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="createtaskmodalLabel">Create Task</h4>
                </div>

                <div class="modal-body">
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-12">
                                <input class="form-control" type="text" id="summary_ct" name="summary_ct" placeholder="Task Summary" style="min-width:540px;">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-6">
                                <input class="form-control" type="text" id="duedate_ct" name="duedate_ct" placeholder="Due Date">
                            </div>
                            <div class="col-xs-6">
                                <input class="form-control" type="text" id="assignee_ct" name="assignee_ct" placeholder="Assignee">
                            </div>
                        </div>
                    </div>
   
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-12">
                                <textarea class="form-control" type="text" id="description_ct" name="description_ct" placeholder="Description" rows="2"  style="min-width:540px;"></textarea>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
                    <button type="button" id="ct_btn" name="ct_btn" class="btn btn-primary">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="taskdetailmodal" tabindex="-1" role="dialog" aria-labelledby="taskdetailmodalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="taskdetailmodalLabel">Task Detail</h4>
                    <div class="task-btn-link">
                        <button class="btn bg-info" id="updateissuelink" name="updateissuelink" onclick="UpdateIssueLink()">Edit Task</button>
                        <button class="btn bg-info" id="linkexisttasks" name="linkexisttasks" onclick="LinkExistTasks()">Link Exist Task</button>
                    </div>
                </div>

                <div class="modal-body">
                    <div class="panel">
                        <div class="TaskTitle">
                            <div class="TaskLabel" id="tasktitle" name="tasktitle">This is a PM Task</div>
                        </div>
                        <div class="TaskField">
                            <div class="TaskLabel">Asignee</div>
                            <div class="TaskLabelVal" id="taskassignee" name="taskassignee">ALEX.CHEN</div>
                        </div>
                        <div class="TaskField">
                            <div class="TaskLabel">Due Data</div>
                            <div class="TaskLabelVal" id="taskduedate" name="taskduedate">2018-08-18</div>
                        </div>
                        <div class="TaskField">
                            <div class="TaskLabel">Resolution</div>
                            <div class="TaskLabelVal" id="taskresolution" name="taskresolution">Done</div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="TaskTitle">
                            <div class="TaskLabel">Related Task</div>
                        </div>

                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Summary</th>
                                    <th>Assignee</th>
                                    <th>Due Date</th>
                                    <th>Remark</th>
                                    <th>Status</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="RelatedTask" name="RelatedTask">
                            </tbody>
                        </table>
                    </div>

                    <div class="panel">
                        <div class="TaskTitle">
                            <div class="TaskLabel">Attachments</div>
                            <div class="TaskLabelVal">
                                <span class="btn btn-default btn-file" id="choosefile3" style="padding:0px;background-color:transparent !important;border-color:transparent !important;">
                                    <img src="~/Content/images/icon/Upload.png" MYTP="HOVER" style="height:20px; width:34px"> <input type="file" name="files3" id="file3" runat="server" onchange="UploadAttach()" />
                                </span>
                            </div>
                        </div>
                        <div class="form-group">
                            <div id="taskattachments" name="taskattachments"></div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="TaskTitle">
                            <div class="TaskLabel">Remark</div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-10"><input type="text" class="form-control" id="taskremark" name="taskremark" placeholder="Remark" value=""></div>
                                <div class="col-xs-2">
                                    <button class="btn btn-success" id="taskremarkbtn" name="taskremarkbtn" onclick="SaveTaskRemark()">Save</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div id="taskcomments"></div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="linktaskmodal" tabindex="-1" role="dialog" aria-labelledby="linktaskmodalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="linktaskmodalLabel">Link Task</h4>
                </div>
                <br>
                <div class="row">
                    <div class="bs-example" style="text-align:center">
                        <div class="col-lg-1">
                        </div>
                        <div class="col-lg-4">
                            <input class="form-control" id="searchkey" name="searchkey">
                        </div>
                        <div class="col-lg-2">
                            <button type="button" class="form-control" id="btn-search" style="background-color:#006DC0;height:35px;color:white;">Search Task</button>
                        </div>
                    </div>
                </div>
                <br>
                <div class="row">
                    <div id="demoparent" class="bs-example" style="text-align:center">
                        <div id="linktask-demo"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="refreshlinktask()">Close</button>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            function refreshlinktask()
            {
                $('#linktaskmodal').modal('hide');
                var id = $('#currentissuekey').val();
                refreshdetailmodal(id);
            }

            $('body').on('click', '#btn-search', function () {
                if ($('#searchkey').val() == ''){ return false; }
                $('#demoparent').empty();
                $('#demoparent').append('<div id="linktask-demo"></div>');

                var id = $('#currentissuekey').val();
                $('#linktask-demo').lobiList({
                    actions: {
                        load: '/Issue/InitTaskLink?IssueKey='+id+'&searchkey=' + $('#searchkey').val(),
                        move: '/Issue/MoveTaskLink'
                    },
                    enableTodoRemove: false,
                    enableTodoEdit: false,
                    controls: []
                });
            })

            //$(function () {
            //    var id = $('#currentissuekey').val();
            //    $('#linktask-demo').lobiList({
            //        actions: {
            //            load: '/Issue/InitTaskLink?IssueKey='+id+'&searchkey=',
            //            move: '/Issue/MoveTaskLink'
            //        },
            //        enableTodoRemove: false,
            //        enableTodoEdit: false,
            //        controls: []
            //    });
            //});
        </script>
    </div>

}

